-- --------------------------------------------------------------------------------
-- This is an attempt to create a full transactional update
-- --------------------------------------------------------------------------------
DROP PROCEDURE IF EXISTS `update_mangos`; 

DELIMITER $$

CREATE DEFINER=`root`@`localhost` PROCEDURE `update_mangos`()
BEGIN
    DECLARE bRollback BOOL  DEFAULT FALSE ;
    DECLARE CONTINUE HANDLER FOR SQLEXCEPTION SET `bRollback` = TRUE;

  SET @cOldRev = 'required_20000_17_Startup_errors_Cleanup1'; 

  -- Set the new revision string
  SET @cNewRev = 'required_20000_18_Startup_errors_Cleanup2';

  -- Set thisRevision to the column name of db_version in the currently selected database
  SET @cThisRev := ((SELECT column_name FROM information_schema.`COLUMNS` WHERE table_name='db_version' AND table_schema=(SELECT DATABASE() AS thisDB FROM DUAL) AND column_name LIKE 'required%'));

 
  -- Only Proceed if the old values match
  IF @cThisRev = @cOldRev THEN
    -- Make this all a single transaction
    START TRANSACTION;

    -- Apply the Version Change from Old Version to New Version
    SET @query = CONCAT('ALTER TABLE db_version CHANGE COLUMN ',@cOldRev, ' ' ,@cNewRev,' bit;');
    PREPARE stmt1 FROM @query;
    EXECUTE stmt1;
    DEALLOCATE PREPARE stmt1;
    -- The Above block is required for making table changes

    -- -- -- -- Normal Update / Insert / Delete statements will go here  -- -- -- -- --
    
    -- Add Missing Entries
DELETE FROM GAMEOBJECT WHERE GUID IN (48878,48879,48880,48876,48877,48892,48893,48894,48887,48895,48881,18207,17641,48888,48889,48890,48896,48891,48882,48883,48884,48885,48873,48874,48886,48875,48898,48900,48897,48899);

INSERT INTO GAMEOBJECT VALUES(17641,164881,1,1,4133.31,-700.016,283.633,2.25148,0,0,0.902585,0.430511,-180,100,1);
INSERT INTO GAMEOBJECT VALUES(18207,174614,1,1,6297.82,-1972.49,562.09,5.38682,0,0,0.433329,-0.901236,-180,0,1);
INSERT INTO GAMEOBJECT VALUES(48873,173325,1,1,4874.41,-377.052,351.308,2.02458,0,0,0.848048,0.529919,-180,100,1);
INSERT INTO GAMEOBJECT VALUES(48874,174609,1,1,5966.68,-1266.65,381.831,2.1293,0,0,0.87462,0.48481,-180,100,1);
INSERT INTO GAMEOBJECT VALUES(48875,174685,1,1,6599.99,-800.007,479.249,2.14675,0,0,0.878817,0.477159,-180,100,1);
INSERT INTO GAMEOBJECT VALUES(48876,164882,1,1,3766.65,-1400,203.65,-0.453786,0,0,0.224951,-0.97437,-180,100,1);
INSERT INTO GAMEOBJECT VALUES(48877,171940,1,1,3866.65,-1000.02,244.199,0.942478,0,0,0.45399,0.891007,-180,100,1);
INSERT INTO GAMEOBJECT VALUES(48878,164884,1,1,4066.66,-1233.34,282.075,-1.15192,0,0,0.544639,-0.838671,-180,100,1);
INSERT INTO GAMEOBJECT VALUES(48879,173326,1,1,6233.34,-1533.33,441.796,0,0,0,0,1,-180,100,1);
INSERT INTO GAMEOBJECT VALUES(48880,174616,1,1,6866.66,-1566.67,496.312,-1.23918,0,0,0.580703,-0.814116,-180,100,1);
INSERT INTO GAMEOBJECT VALUES(48881,164883,1,1,3866.64,-666.657,329.731,-2.37365,0,0,0.927184,-0.374607,-180,100,1);
INSERT INTO GAMEOBJECT VALUES(48882,174622,1,1,6433.25,-1266.62,383.206,2.23402,0,0,0.898794,0.438371,-180,100,1);
INSERT INTO GAMEOBJECT VALUES(48883,174623,1,1,6666.67,-1200,471.328,2.16421,0,0,0.882948,0.469472,-180,100,1);
INSERT INTO GAMEOBJECT VALUES(48884,174624,1,1,6400,-699.992,477.424,2.60054,0,0,0.96363,0.267238,-180,100,1);
INSERT INTO GAMEOBJECT VALUES(48885,174625,1,1,5333.33,-833.325,342.732,0.628319,0,0,0.309017,0.951057,-180,100,1);
INSERT INTO GAMEOBJECT VALUES(48886,174687,1,1,4824.34,-316.803,358.791,-2.21657,0,0,0.894934,-0.446198,-180,100,1);
INSERT INTO GAMEOBJECT VALUES(48887,174617,1,1,6366.68,-1666.65,480.265,-1.13446,0,0,0.5373,-0.843391,-180,100,1);
INSERT INTO GAMEOBJECT VALUES(48888,174618,1,1,6433.33,-966.665,422.408,2.05949,0,0,0.857167,0.515038,-180,100,1);
INSERT INTO GAMEOBJECT VALUES(48889,174619,1,1,6292.07,-588.73,467.669,1.09956,0,0,0.522499,0.85264,-180,100,1);
INSERT INTO GAMEOBJECT VALUES(48890,174620,1,1,5266.67,-333.332,325.469,2.23402,0,0,0.898794,0.438371,-180,100,1);
INSERT INTO GAMEOBJECT VALUES(48891,174621,1,1,4866.69,-600.011,307.548,0.645772,0,0,0.317305,0.948324,-180,100,1);
INSERT INTO GAMEOBJECT VALUES(48892,171943,1,1,4233.32,-1133.32,322.629,1.64061,0,0,0.731354,0.681998,-180,100,1);
INSERT INTO GAMEOBJECT VALUES(48893,174610,1,1,6266.67,-2000.02,573.426,-1.02974,0,0,0.492424,-0.870356,-180,100,1);
INSERT INTO GAMEOBJECT VALUES(48894,174612,1,1,6900,-2033.33,583.696,1.81514,0,0,0.788011,0.615662,-180,100,1);
INSERT INTO GAMEOBJECT VALUES(48895,174613,1,1,6733.31,-1566.68,477.04,-2.82743,0,0,0.987688,-0.156434,-180,100,1);
INSERT INTO GAMEOBJECT VALUES(48896,174615,1,1,5133.34,-333.352,354.553,-1.41372,0,0,0.649448,-0.760406,-180,100,1);
INSERT INTO GAMEOBJECT VALUES(48897,174710,1,1,4757.87,-460.486,337.843,0.226893,0,0,0.113203,0.993572,-180,100,1);
INSERT INTO GAMEOBJECT VALUES(48898,174714,1,1,4966.66,-666.679,295.082,-2.70526,0,0,0.976296,-0.21644,-180,100,1);
INSERT INTO GAMEOBJECT VALUES(48899,174711,1,1,5533.32,-933.35,376.883,1.22173,0,0,0.573576,0.819152,-180,100,1);
INSERT INTO GAMEOBJECT VALUES(48900,174715,1,1,5433.33,-666.653,348.089,1.65806,0,0,0.737277,0.67559,-180,100,1);

-- Add Scripting to warder
UPDATE creature_template SET ScriptName="npc_onyxian_warder" WHERE Entry="12129";

-- Uncouple pool from itself
UPDATE pool_pool SET mother_pool=1000 WHERE pool_id= 12265;
    -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
    
    -- If we get here ok, commit the changes
    IF bRollback = TRUE THEN
      ROLLBACK;
      SELECT '* UPDATE FAILED *' AS 'Status',@cThisRev AS 'DB is on Version';
    ELSE
      COMMIT;
      SELECT '* UPDATE COMPLETE *' AS 'Status',@cNewRev AS 'DB is now on Version';
    END IF;
  ELSE
    SELECT '* UPDATE SKIPPED *' AS 'Status',@cOldRev AS 'Required Version',@cThisRev AS 'Found Version';
  END IF;

END $$

DELIMITER ;

-- Execute the procedure
CALL update_mangos();

-- Drop the procedure
DROP PROCEDURE IF EXISTS `update_mangos`;
