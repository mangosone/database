-- ----------------------------------------
-- Added to prevent timeout's while loading
-- ----------------------------------------
SET GLOBAL net_read_timeout=30;
SET GLOBAL net_write_timeout=60;
SET GLOBAL net_buffer_length=1000000; 
SET GLOBAL max_allowed_packet=1000000000;
SET GLOBAL connect_timeout=10000000;

-- --------------------------------------------------------------------------------
-- This is an attempt to create a full transactional MaNGOS update (v1.3)
-- --------------------------------------------------------------------------------
DROP PROCEDURE IF EXISTS `update_mangos`; 

DELIMITER $$

CREATE DEFINER=`root`@`localhost` PROCEDURE `update_mangos`()
BEGIN
    DECLARE bRollback BOOL  DEFAULT FALSE ;
    DECLARE CONTINUE HANDLER FOR SQLEXCEPTION SET `bRollback` = TRUE;

    -- Current Values (TODO - must be a better way to do this)
    SET @cCurVersion := (SELECT `version` FROM db_version ORDER BY `version` DESC, STRUCTURE DESC, CONTENT DESC LIMIT 0,1);
    SET @cCurStructure := (SELECT structure FROM db_version ORDER BY `version` DESC, STRUCTURE DESC, CONTENT DESC LIMIT 0,1);
    SET @cCurContent := (SELECT content FROM db_version ORDER BY `version` DESC, STRUCTURE DESC, CONTENT DESC LIMIT 0,1);

    -- Expected Values
    SET @cOldVersion = '21'; 
    SET @cOldStructure = '07'; 
    SET @cOldContent = '020';

    -- New Values
    SET @cNewVersion = '21';
    SET @cNewStructure = '07';
    SET @cNewContent = '021';
                            -- DESCRIPTION IS 30 Characters MAX    
    SET @cNewDescription = 'Azuremyst_Isle_Pt2';

                        -- COMMENT is 150 Characters MAX
    SET @cNewComment = 'Azuremyst_Isle_Pt2';

    -- Evaluate all settings
    SET @cCurResult := (SELECT description FROM db_version ORDER BY `version` DESC, STRUCTURE DESC, CONTENT DESC LIMIT 0,1);
    SET @cOldResult := (SELECT description FROM db_version WHERE `version`=@cOldVersion AND `structure`=@cOldStructure AND `content`=@cOldContent);
    SET @cNewResult := (SELECT description FROM db_version WHERE `version`=@cNewVersion AND `structure`=@cNewStructure AND `content`=@cNewContent);

    IF (@cCurResult = @cOldResult) THEN    -- Does the current version match the expected version
        -- APPLY UPDATE
        START TRANSACTION;

        -- UPDATE THE DB VERSION
        -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -
        INSERT INTO `db_version` VALUES (@cNewVersion, @cNewStructure, @cNewContent, @cNewDescription, @cNewComment);
        SET @cNewResult := (SELECT description FROM db_version WHERE `version`=@cNewVersion AND `structure`=@cNewStructure AND `content`=@cNewContent);

        -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -
        -- -- PLACE UPDATE SQL BELOW -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
        -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -
-- Azuremyst Isle Pt.2

-- Duplicates
DELETE FROM creature WHERE guid IN (63772,63769,63770);
DELETE FROM creature_addon WHERE guid IN (63772,63769,63770);
DELETE FROM creature_movement WHERE id IN (63772,63769,63770);
DELETE FROM npc_gossip WHERE npc_guid IN (63770,63772,63769);

-- Ammen Vale Guardian - missing added 
SET @GUID := (SELECT MAX(guid) FROM `creature`);
INSERT INTO creature (guid, id, map, spawnMask, modelid, equipment_id, position_x, position_y, position_z, orientation, spawntimesecs, spawndist, currentwaypoint, curhealth, curmana, DeathState, MovementType) VALUES 
(@GUID+1,16921,530,1,0,405,-4247.23,-13229.8,62.089,5.67232,300,0,0,11828,0,0,0),
(@GUID+2,16921,530,1,0,405,-4251.78,-13213.4,64.4749,1.553343,300,0,0,11828,0,0,0),
(@GUID+3,16921,530,1,0,405,-4266.62,-13213.4,66.5232,1.48353,300,0,0,11828,0,0,0),
(@GUID+4,16921,530,1,0,405,-4246.85,-13189.1,68.4469,3.193953,300,0,0,11828,0,0,0),
(@GUID+5,16921,530,1,0,405,-4265.27,-13183.5,59.3392,1.815142,300,0,0,11828,0,0,0),
-- Draenei Artificer
(63769,17228,530,1,0,2,-4214.15,-12468.7,45.3208,1.77108,120,0,0,114,131,0,0), -- guid reused
(63770,17228,530,1,0,2,-4149.24,-12465,45.3466,5.67608,120,0,0,98,115,0,0); -- guid reused

-- School of Red Snapper - duplicates
DELETE FROM gameobject WHERE guid = 22049;
-- Valaar's Berth
DELETE FROM gameobject WHERE guid = 22304;

-- Jaeleil
-- She's been moved to Azure Watch (patch 2.4.3)
UPDATE creature SET position_x = -4173.207, position_y = -12499.23, position_z = 45.40657, orientation = 0.4014257, MovementType = 0, spawndist = 0 WHERE guid = 57174;
UPDATE creature_template_addon SET bytes1 = 1 WHERE entry = 16476;

-- Azuremyst Peacekeeper
UPDATE creature SET position_x = -4191.937988, position_y = -12478.247070, position_z = 45.769424, orientation = 3.565038, MovementType = 2, spawndist = 0 WHERE guid = 63771;
UPDATE creature SET position_x = -4121.803223, position_y = -12498.709961, position_z = 43.091747, orientation = 0.392636, MovementType = 2, spawndist = 0 WHERE guid = 63774;
UPDATE creature SET MovementType = 2, spawndist = 0 WHERE guid IN (63773,63775);
DELETE FROM creature_movement WHERE id IN (63771,63773,63774,63775); 
INSERT INTO creature_movement (id, point, position_x, position_y, position_z, waittime, script_id, orientation, model1, model2) VALUES
-- #63771
(63771,1,-4205.66,-12485.6,44.6914, 0, 0,4.15409, 0, 0),
(63771,2,-4208.53,-12498.6,44.4324, 0, 0,4.92377, 0, 0),
(63771,3,-4204.51,-12510.6,44.8193, 0, 0,5.3508, 0, 0),
(63771,4,-4193.44,-12522.6,44.6915, 0, 0,5.94219, 0, 0),
(63771,5,-4176.15,-12527.4,44.6961, 0, 0,0.249204, 0, 0),
(63771,6,-4163.38,-12521.9,44.6597, 0, 0,0.702007, 0, 0),
(63771,7,-4155.31,-12511.3,44.8935, 0, 0,1.12926, 0, 0),
(63771,8,-4153.65,-12498,44.3924, 0, 0,1.69789, 0, 0),
(63771,9,-4156.06,-12489.1,44.4723, 0, 0,1.96493, 0, 0),
(63771,10,-4169.8,-12465.3,44.482, 0, 0,1.77172, 0, 0),
(63771,11,-4172.35,-12441.4,43.6913, 0, 0,1.65784, 0, 0),
(63771,12,-4183.24,-12464.9,44.8085, 0, 0,4.18289, 0, 0),
(63771,13,-4193.13,-12477.9,45.7905, 0, 0,3.83339, 0, 0),
-- #63773
(63773,1,-4233.12,-12487.6,41.7459, 1000, 1803801,2.86864, 0, 0),
(63773,2,-4253.76,-12480.8,34.8627, 0, 0,2.86942, 0, 0),
(63773,3,-4268.75,-12476.1,29.0027, 0, 0,2.85372, 0, 0),
(63773,4,-4288.66,-12471.6,24.2334, 0, 0,3.35166, 0, 0),
(63773,5,-4309.47,-12477.6,20.8072, 0, 0,3.25937, 0, 0),
(63773,6,-4320.71,-12477.5,18.5734, 0, 0,2.79751, 0, 0),
(63773,7,-4337.38,-12470.9,14.84, 0, 0,3.07475, 0, 0),
(63773,8,-4368.72,-12468.9,9.63387, 0, 0,2.87448, 0, 0),
(63773,9,-4396.24,-12458.8,5.97987, 0, 0,2.76845, 0, 0),
(63773,10,-4413.7,-12450.7,3.52516, 0, 0,2.88233, 0, 0),
(63773,11,-4441.16,-12442.9,2.06393, 0, 0,2.84306, 0, 0),
(63773,12,-4463.41,-12432.1,2.65485, 0, 0,2.6742, 0, 0),
(63773,13,-4488,-12421.2,3.67053, 0, 0,2.76845, 0, 0),
(63773,14,-4502.04,-12413.8,4.58676, 0, 0,2.82343, 0, 0),
(63773,15,-4528.75,-12416.2,6.93748, 0, 0,3.23576, 0, 0),
(63773,16,-4545,-12415.7,8.3341, 0, 0,3.19256, 0, 0),
(63773,17,-4567.34,-12417.9,9.11502, 0, 0,3.14544, 0, 0),
(63773,18,-4545.31,-12416.2,8.32012, 0, 0,0.0391042, 0, 0),
(63773,19,-4524.5,-12416.2,6.32431, 0, 0,0.113716, 0, 0),
(63773,20,-4506.8,-12413.8,4.77744, 0, 0,6.16364, 0, 0),
(63773,21,-4488.36,-12419.3,3.81805, 0, 0,5.97514, 0, 0),
(63773,22,-4462.29,-12432.7,2.63905, 0, 0,5.78665, 0, 0),
(63773,23,-4444.97,-12442.7,1.96238, 0, 0,5.93195, 0, 0),
(63773,24,-4412.28,-12451.8,3.74838, 0, 0,5.97514, 0, 0),
(63773,25,-4389.28,-12461.4,6.76621, 0, 0,5.86126, 0, 0),
(63773,26,-4373.72,-12469.6,9.03604, 0, 0,5.86519, 0, 0),
(63773,27,-4363.62,-12473.2,10.645, 0, 0,0.179689, 0, 0),
(63773,28,-4337.64,-12470.9,14.7957, 0, 0,6.05054, 0, 0),
(63773,29,-4320.31,-12477.7,18.6569, 0, 0,6.22725, 0, 0),
(63773,30,-4309.21,-12477.5,20.8536, 0, 0,0.383891, 0, 0),
(63773,31,-4288.19,-12471.8,24.3448, 0, 0,6.14243, 0, 0),
(63773,32,-4267.45,-12476.5,29.4462, 0, 0,5.99321, 0, 0),
(63773,33,-4254.15,-12480.6,34.7295, 0, 0,5.97357, 0, 0),
(63773,34,-4233.21,-12487.7,41.7129, 0, 0,5.68219, 0, 0),
(63773,35,-4208.26,-12501.5,44.7111, 0, 0,5.75759, 0, 0),
(63773,36,-4187.88,-12513.6,44.3435, 0, 0,6.0906, 0, 0),
(63773,37,-4172.63,-12514.9,44.3647, 0, 0,0.0116143, 0, 0),
(63773,38,-4156.03,-12509,44.4737, 0, 0,0.137278, 0, 0),
(63773,39,-4133.4,-12503.9,43.4838, 1000, 1803802,0.211891, 0, 0),
(63773,40,-4162.65,-12511.3,44.391, 0, 0,3.4438, 0, 0),
(63773,41,-4177.89,-12515.7,44.3673, 0, 0,3.21997, 0, 0),
(63773,42,-4189.41,-12512.8,44.3664, 0, 0,2.67961, 0, 0),
(63773,43,-4219.91,-12494.9,44.1521, 0, 0,2.62463, 0, 0),
-- #63774
(63774,1,-4106.05,-12492.3,41.6468, 1000, 1803801,0.0674809, 0, 0),
(63774,2,-4088.56,-12487.2,38.7601, 0, 0,0.486884, 0, 0),
(63774,3,-4074.76,-12477,36.6925, 0, 0,0.427194, 0, 0),
(63774,4,-4056.05,-12470.8,33.9505, 0, 0,0.470391, 0, 0),
(63774,5,-4034.42,-12460.5,30.9639, 0, 0,0.222991, 0, 0),
(63774,6,-4018.51,-12459.1,28.2487, 0, 0,0.423267, 0, 0),
(63774,7,-3982.07,-12444.5,21.3301, 0, 0,0.321165, 0, 0),
(63774,8,-3962.04,-12437.8,17.0843, 0, 0,0.572493, 0, 0),
(63774,9,-3942.13,-12427.6,12.5359, 0, 0,0.0588423, 0, 0),
(63774,10,-3921.28,-12428.5,8.93809, 0, 0,0.2277, 0, 0),
(63774,11,-3890.14,-12421.4,2.94878, 0, 0,0.490809, 0, 0),
(63774,12,-3855.8,-12404.4,-0.599702, 0, 0,0.314094, 0, 0),
(63774,13,-3835.38,-12399.9,-0.790897, 0, 0,0.0902556, 0, 0),
(63774,14,-3796.89,-12397.1,-1.57472, 0, 0,0.0195698, 0, 0),
(63774,15,-3782.26,-12398.9,-1.78966, 0, 0,0.255189, 0, 0),
(63774,16,-3763.04,-12388.9,-1.70261, 0, 0,0.2277, 0, 0),
(63774,17,-3722.08,-12384.9,-3.18091, 0, 0,0.282678, 0, 0),
(63774,18,-3684.53,-12370.5,-3.32684, 0, 0,0.396561, 0, 0),
(63774,19,-3643.22,-12356.1,-2.45317, 0, 0,0.26697, 0, 0),
(63774,20,-3627.6,-12355.1,-1.34103, 0, 0,6.16531, 0, 0),
(63774,21,-3604.32,-12361.9,0.61728, 0, 0,6.21244, 0, 0),
(63774,22,-3565.76,-12359.3,3.63315, 0, 0,6.24385, 0, 0),
(63774,23,-3604.17,-12361.8,0.635082, 0, 0,3.11011, 0, 0),
(63774,24,-3627.97,-12355,-1.34952, 0, 0,3.13289, 0, 0),
(63774,25,-3642.15,-12355.8,-2.40368, 0, 0,3.34887, 0, 0),
(63774,26,-3662.5,-12360,-2.69549, 0, 0,3.48239, 0, 0),
(63774,27,-3700.76,-12378.8,-3.49316, 0, 0,3.58842, 0, 0),
(63774,28,-3728.97,-12385.9,-3.05378, 0, 0,3.35673, 0, 0),
(63774,29,-3749.81,-12385,-1.97987, 0, 0,3.31353, 0, 0),
(63774,30,-3764.88,-12387.6,-1.69781, 0, 0,3.52559, 0, 0),
(63774,31,-3783.67,-12397.7,-1.81325, 0, 0,3.2452, 0, 0),
(63774,32,-3809.32,-12396.3,-1.48745, 0, 0,3.29233, 0, 0),
(63774,33,-3846.04,-12400.8,-0.593908, 0, 0,3.2452, 0, 0),
(63774,34,-3874.13,-12412.1,0.695393, 0, 0,3.54758, 0, 0),
(63774,35,-3892.58,-12422.1,3.30651, 0, 0,3.47297, 0, 0),
(63774,36,-3908.92,-12423.9,6.47097, 0, 0,3.52402, 0, 0),
(63774,37,-3924.91,-12429,9.35508, 0, 0,3.31196, 0, 0),
(63774,38,-3948.46,-12428.2,13.8682, 0, 0,3.70702, 0, 0),
(63774,39,-3976.52,-12445.1,20.2205, 0, 0,3.31432, 0, 0),
(63774,40,-3993.88,-12447,23.7009, 0, 0,3.44391, 0, 0),
(63774,41,-4019.37,-12458.6,28.3566, 0, 0,3.41249, 0, 0),
(63774,42,-4036.01,-12459.6,31.0169, 0, 0,3.45176, 0, 0),
(63774,43,-4061.94,-12473.4,34.7949, 0, 0,3.58135, 0, 0),
(63774,44,-4078.57,-12478.3,37.0618, 0, 0,3.68345, 0, 0),
(63774,45,-4090.85,-12487.5,39.2156, 0, 0,3.52245, 0, 0),
(63774,46,-4115.91,-12495.1,42.6562, 0, 0,3.60491, 0, 0),
(63774,47,-4135.13,-12503,43.4695, 0, 0,3.34966, 0, 0),
(63774,48,-4155.84,-12502.8,44.2209, 0, 0,2.94911, 0, 0),
(63774,49,-4172.29,-12490.5,44.0644, 0, 0,2.76454, 0, 0),
(63774,50,-4183.76,-12489.3,44.3628, 0, 0,3.33788, 0, 0),
(63774,51,-4202.05,-12497.1,44.3641, 0, 0,3.17294, 0, 0),
(63774,52,-4216.59,-12495.1,44.3567, 0, 0,2.91376, 0, 0),
(63774,53,-4232.25,-12489.8,42.0015, 1000, 1803802,2.81166, 0, 0),
(63774,54,-4207.35,-12497.7,44.4138, 0, 0,6.17316, 0, 0),
(63774,55,-4192.17,-12498.4,44.3717, 0, 0,0.581123, 0, 0),
(63774,56,-4183.4,-12489.6,44.3618, 0, 0,0.187639, 0, 0),
(63774,57,-4172.96,-12490.9,44.1005, 0, 0,5.69878, 0, 0),
(63774,58,-4160.64,-12501.8,44.3744, 0, 0,5.95392, 0, 0),
(63774,59,-4135.05,-12503.6,43.5005, 0, 0,0.240147, 0, 0),
-- #63775
(63775,1,-4252.89,-12393.9,14.5194, 0, 0,1.05696, 0, 0),
(63775,2,-4236.92,-12362,8.88869, 0, 0,1.08053, 0, 0),
(63775,3,-4221.71,-12334.4,3.76085, 0, 0,1.06089, 0, 0),
(63775,4,-4207.3,-12310.4,1.43233, 0, 0,0.966642, 0, 0),
(63775,5,-4193.96,-12289,0.234154, 0, 0,0.962715, 0, 0),
(63775,6,-4177.63,-12268.3,-0.362697, 0, 0,0.751443, 0, 0),
(63775,7,-4160.39,-12248.7,-0.90721, 0, 0,1.0067, 0, 0),
(63775,8,-4153.88,-12237.2,-0.976952, 0, 0,1.13629, 0, 0),
(63775,9,-4140.68,-12203.6,-1.06667, 0, 0,1.22661, 0, 0),
(63775,10,-4127.23,-12173.1,-1.24787, 0, 0,1.14414, 0, 0),
(63775,11,-4115.24,-12148,-1.53803, 0, 0,1.04989, 0, 0),
(63775,12,-4105.68,-12132.6,-0.95673, 0, 0,1.03811, 0, 0),
(63775,13,-4094.46,-12115.3,-1.12745, 0, 0,0.971355, 0, 0),
(63775,14,-4082.87,-12103.9,-0.749816, 0, 0,1.04597, 0, 0),
(63775,15,-4078.97,-12096.5,-0.560868, 0, 0,1.4583, 0, 0),
(63775,16,-4075.17,-12077.3,-0.529888, 0, 0,1.30908, 0, 0),
(63775,17,-4069.51,-12055,-1.09205, 0, 0,1.58789, 0, 0),
(63775,18,-4073.41,-12026.3,-1.53289, 0, 0,1.70963, 0, 0),
(63775,19,-4073.54,-12016.2,-1.32729, 0, 0,1.42296, 0, 0),
(63775,20,-4070.18,-12003,-1.09959, 0, 0,1.28159, 0, 0),
(63775,21,-4073.9,-12022.1,-1.5401, 0, 0,4.81195, 0, 0),
(63775,22,-4069.62,-12052.3,-1.14399, 0, 0,4.62345, 0, 0),
(63775,23,-4071.28,-12066.1,-0.960025, 0, 0,4.4546, 0, 0),
(63775,24,-4078.13,-12086.2,-0.369815, 0, 0,4.53706, 0, 0),
(63775,25,-4080.28,-12101.7,-0.643288, 0, 0,4.25825, 0, 0),
(63775,26,-4084.06,-12106.7,-0.643821, 0, 0,4.0462, 0, 0),
(63775,27,-4094.83,-12115.7,-1.1648, 0, 0,4.08939, 0, 0),
(63775,28,-4105.67,-12132.2,-0.74096, 0, 0,4.14044, 0, 0),
(63775,29,-4118.7,-12153.8,-1.5499, 0, 0,4.27396, 0, 0),
(63775,30,-4130.34,-12179.3,-1.19709, 0, 0,4.28181, 0, 0),
(63775,31,-4141.06,-12205.1,-1.01354, 0, 0,4.36428, 0, 0),
(63775,32,-4151.27,-12231.1,-0.87849, 0, 0,4.32108, 0, 0),
(63775,33,-4157.82,-12245.5,-0.7944, 0, 0,4.17186, 0, 0),
(63775,34,-4166.52,-12257.3,-0.743649, 0, 0,3.96373, 0, 0),
(63775,35,-4186.14,-12278,-0.193023, 0, 0,4.14437, 0, 0),
(63775,36,-4199.8,-12296.4,0.450192, 0, 0,4.17185, 0, 0),
(63775,37,-4212.18,-12317.5,1.91781, 0, 0,4.18363, 0, 0),
(63775,38,-4227.93,-12344.8,5.56905, 0, 0,4.19149, 0, 0),
(63775,39,-4239.32,-12366.5,9.91899, 0, 0,4.23861, 0, 0),
(63775,40,-4246.31,-12383.7,12.9142, 0, 0,4.13651, 0, 0),
(63775,41,-4258.05,-12400.7,15.6502, 0, 0,4.29359, 0, 0),
(63775,42,-4271.89,-12426.1,18.9704, 0, 0,4.06976, 0, 0),
(63775,43,-4283.4,-12441.8,21.1821, 0, 0,4.43104, 0, 0),
(63775,44,-4288.12,-12454.5,22.8085, 0, 0,4.79624, 0, 0),
(63775,45,-4287.93,-12469.4,24.3007, 0, 0,5.53844, 0, 0),
(63775,46,-4279.27,-12473.6,26.3407, 0, 0,5.93506, 0, 0),
(63775,47,-4260.21,-12479.1,32.2185, 0, 0,5.99397, 0, 0),
(63775,48,-4231.34,-12490,42.2273, 0, 0,5.80155, 0, 0),
(63775,49,-4248.46,-12482.2,36.9041, 0, 0,2.78954, 0, 0),
(63775,50,-4269.78,-12476.8,28.7176, 0, 0,2.92306, 0, 0),
(63775,51,-4283.67,-12472.2,25.4016, 0, 0,2.43847, 0, 0),
(63775,52,-4288.29,-12466.3,24.1346, 0, 0,1.73318, 0, 0),
(63775,53,-4286.72,-12449.5,22.2292, 0, 0,1.32478, 0, 0),
(63775,54,-4281.04,-12437.8,20.8325, 0, 0,0.900661, 0, 0),
(63775,55,-4269.86,-12424.9,18.708, 0, 0,1.03418, 0, 0),
(63775,56,-4265.07,-12413.7,17.6402, 0, 0,1.16377, 0, 0);
DELETE FROM db_scripts WHERE id IN (1803801,1803802);
INSERT INTO db_scripts (script_type, id, delay, command, datalong, datalong2, buddy_entry, search_radius, data_flags, dataint, dataint2, dataint3, dataint4, x, y, z, o, comments) VALUES
(3,1803801,1,21,1,0,0,0,0,0,0,0,0,0,0,0,0,'active'),
(3,1803802,1,21,0,0,0,0,0,0,0,0,0,0,0,0,0,'unactive');
    
    

        -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -
        -- -- PLACE UPDATE SQL ABOVE -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
        -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -

        -- If we get here ok, commit the changes
        IF bRollback = TRUE THEN
            ROLLBACK;
            SHOW ERRORS;
            SELECT '* UPDATE FAILED *' AS `===== Status =====`,@cCurResult AS `===== DB is on Version: =====`;



        ELSE
            COMMIT;
            SELECT '* UPDATE COMPLETE *' AS `===== Status =====`,@cNewResult AS `===== DB is now on Version =====`;
        END IF;
    ELSE    -- Current version is not the expected version
        IF (@cCurResult = @cNewResult) THEN    -- Does the current version match the new version
            SELECT '* UPDATE SKIPPED *' AS `===== Status =====`,@cCurResult AS `===== DB is already on Version =====`;
        ELSE    -- Current version is not one related to this update
            IF(@cCurResult IS NULL) THEN    -- Something has gone wrong
                SELECT '* UPDATE FAILED *' AS `===== Status =====`,'Unable to locate DB Version Information' AS `============= Error Message =============`;
            ELSE
		IF(@cOldResult IS NULL) THEN    -- Something has gone wrong
		    SET @cCurVersion := (SELECT `version` FROM db_version ORDER BY `version` DESC, STRUCTURE DESC, CONTENT DESC LIMIT 0,1);
		    SET @cCurStructure := (SELECT `STRUCTURE` FROM db_version ORDER BY `version` DESC, STRUCTURE DESC, CONTENT DESC LIMIT 0,1);
		    SET @cCurContent := (SELECT `Content` FROM db_version ORDER BY `version` DESC, STRUCTURE DESC, CONTENT DESC LIMIT 0,1);
                    SET @cCurOutput = CONCAT(@cCurVersion, '_', @cCurStructure, '_', @cCurContent, ' - ',@cCurResult);
                    SET @cOldResult = CONCAT('Rel',@cOldVersion, '_', @cOldStructure, '_', @cOldContent, ' - ','IS NOT APPLIED');
                    SELECT '* UPDATE SKIPPED *' AS `===== Status =====`,@cOldResult AS `=== Expected ===`,@cCurOutput AS `===== Found Version =====`;
		ELSE
		    SET @cCurVersion := (SELECT `version` FROM db_version ORDER BY `version` DESC, STRUCTURE DESC, CONTENT DESC LIMIT 0,1);
		    SET @cCurStructure := (SELECT `STRUCTURE` FROM db_version ORDER BY `version` DESC, STRUCTURE DESC, CONTENT DESC LIMIT 0,1);
		    SET @cCurContent := (SELECT `Content` FROM db_version ORDER BY `version` DESC, STRUCTURE DESC, CONTENT DESC LIMIT 0,1);
                    SET @cCurOutput = CONCAT(@cCurVersion, '_', @cCurStructure, '_', @cCurContent, ' - ',@cCurResult);
                    SELECT '* UPDATE SKIPPED *' AS `===== Status =====`,@cOldResult AS `=== Expected ===`,@cCurOutput AS `===== Found Version =====`;
                END IF;
            END IF;
        END IF;
    END IF;
END $$

DELIMITER ;

-- Execute the procedure
CALL update_mangos();

-- Drop the procedure
DROP PROCEDURE IF EXISTS `update_mangos`;

