-- ----------------------------------------
-- Added to prevent timeout's while loading
-- ----------------------------------------
SET GLOBAL net_read_timeout=30;
SET GLOBAL net_write_timeout=60;
SET GLOBAL net_buffer_length=1000000; 
SET GLOBAL max_allowed_packet=1000000000;
SET GLOBAL connect_timeout=10000000;

-- --------------------------------------------------------------------------------
-- This is an attempt to create a full transactional MaNGOS update (v1.3)
-- --------------------------------------------------------------------------------
DROP PROCEDURE IF EXISTS `update_mangos`; 

DELIMITER $$

CREATE DEFINER=`root`@`localhost` PROCEDURE `update_mangos`()
BEGIN
    DECLARE bRollback BOOL  DEFAULT FALSE ;
    DECLARE CONTINUE HANDLER FOR SQLEXCEPTION SET `bRollback` = TRUE;

    -- Current Values (TODO - must be a better way to do this)
    SET @cCurVersion := (SELECT `version` FROM db_version ORDER BY `version` DESC, STRUCTURE DESC, CONTENT DESC LIMIT 0,1);
    SET @cCurStructure := (SELECT structure FROM db_version ORDER BY `version` DESC, STRUCTURE DESC, CONTENT DESC LIMIT 0,1);
    SET @cCurContent := (SELECT content FROM db_version ORDER BY `version` DESC, STRUCTURE DESC, CONTENT DESC LIMIT 0,1);

    -- Expected Values
    SET @cOldVersion = '21'; 
    SET @cOldStructure = '07'; 
    SET @cOldContent = '043';

    -- New Values
    SET @cNewVersion = '21';
    SET @cNewStructure = '07';
    SET @cNewContent = '044';
                            -- DESCRIPTION IS 30 Characters MAX    
    SET @cNewDescription = 'q11008_overhall';

                        -- COMMENT is 150 Characters MAX
    SET @cNewComment = 'q11008_overhall';

    -- Evaluate all settings
    SET @cCurResult := (SELECT description FROM db_version ORDER BY `version` DESC, STRUCTURE DESC, CONTENT DESC LIMIT 0,1);
    SET @cOldResult := (SELECT description FROM db_version WHERE `version`=@cOldVersion AND `structure`=@cOldStructure AND `content`=@cOldContent);
    SET @cNewResult := (SELECT description FROM db_version WHERE `version`=@cNewVersion AND `structure`=@cNewStructure AND `content`=@cNewContent);

    IF (@cCurResult = @cOldResult) THEN    -- Does the current version match the expected version
        -- APPLY UPDATE
        START TRANSACTION;

        -- UPDATE THE DB VERSION
        -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -
        INSERT INTO `db_version` VALUES (@cNewVersion, @cNewStructure, @cNewContent, @cNewDescription, @cNewComment);
        SET @cNewResult := (SELECT description FROM db_version WHERE `version`=@cNewVersion AND `structure`=@cNewStructure AND `content`=@cNewContent);

        -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -
        -- -- PLACE UPDATE SQL BELOW -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
        -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -

	update `gameobject_template` set `data3` = '3000' where `entry` = '185549';
	delete from `spell_script_target` where `entry` = 39844 and `targetEntry` = 185549;
	insert into `spell_script_target` (`entry`, `targetEntry`) values ('39844', '185549');


	update `creature_template` set `ExtraFlags` = '2' where `Entry` = '22991';


	delete from `db_scripts` where `id` = 39844;
	insert into `db_scripts` (`script_guid`, `script_type`, `id`, `delay`, `command`, `datalong`, `datalong2`, `buddy_entry`, `search_radius`, `data_flags`, `dataint`, `dataint2`, `dataint3`, `dataint4`, `x`, `y`, `z`, `o`, `comments`) values
	('4205','5','39844','0','8','0','0','0','0','0','0','0','0','0','0','0','0','0','quest 11008 kill credit'),
	('4206','5','39844','1','18','0','0','0','0','0','0','0','0','0','0','0','0','0','despawn 11008 trigger despawn');

	-- Remove / Replace both kill marker and game object.
	-- This will insure correct spawn locations and remove duplicate entries 
	delete from `gameobject` where `id` = 185549;
	insert into `gameobject` (`id`, `map`, `spawnMask`, `position_x`, `position_y`, `position_z`, `orientation`, `rotation0`, `rotation1`, `rotation2`, `rotation3`, `spawntimesecs`, `animprogress`, `state`) values
	('185549','530','1','-3857.69','3426.25','363.733','-0.087267','0','0','-0.0436197','0.999048','180','100','1'),
	('185549','530','1','-3845.16','3332.2','338.59','2.9147','0','0','0.993572','0.113203','180','100','1'),
	('185549','530','1','-3965.16','3232.7','347.552','-0.122173','0','0','-0.0610485','0.998135','180','100','1'),
	('185549','530','1','-3953.3','3227.94','347.564','-0.244346','0','0','-0.121869','0.992546','180','100','1'),
	('185549','530','1','-3955.86','3222.16','347.503','0.244346','0','0','0.121869','0.992546','180','100','1'),
	('185549','530','1','-4044.66','3287.29','348.362','0.349066','0','0','0.173648','0.984808','180','100','1'),
	('185549','530','1','-4041.39','3271','346.642','-2.09439','0','0','-0.866024','0.500002','180','100','1'),
	('185549','530','1','-4049.31','3285.9','348.335','1.43117','0','0','0.656059','0.75471','180','100','1'),
	('185549','530','1','-4076.99','3415.22','334.008','-2.33874','0','0','-0.920505','0.390732','180','100','1'),
	('185549','530','1','-4076.79','3412.91','334.617','-1.0821','0','0','-0.515036','0.857168','180','100','1'),
	('185549','530','1','-4077.92','3412.57','334.768','-0.733038','0','0','-0.358368','0.93358','180','100','1'),
	('185549','530','1','-4107.93','3121.5','357.427','1.01229','0','0','0.484809','0.87462','180','100','1'),
	('185549','530','1','-4108.31','3123.66','357.633','-0.680679','0','0','-0.333807','0.942641','180','100','1'),
	('185549','530','1','-4110.19','3122.64','358.083','-0.034907','0','0','-0.0174526','0.999848','180','100','1'),
	('185549','530','1','-3996.89','3142.12','372.729','3.05433','0','0','0.999048','0.0436174','180','100','1'),
	('185549','530','1','-4109.06','3019.1','352.24','0.261799','0','0','0.130526','0.991445','180','100','1'),
	('185549','530','1','-4018.35','3076.7','375.29','-0.733038','0','0','-0.358368','0.93358','180','100','1'),
	('185549','530','1','-4184.98','3044.71','352.394','1.81514','0','0','0.78801','0.615662','180','100','1'),
	('185549','530','1','-4187.52','3040.39','352.071','-0.017453','0','0','-0.00872639','0.999962','180','100','1'),
	('185549','530','1','-4189.67','3039.9','352.247','-0.785398','0','0','-0.382683','0.92388','180','100','1'),
	('185549','530','1','-4192.61','3045.1','352.096','3.14159','0','0','1','0.00000126759','180','100','1'),
	('185549','530','1','-4192.02','3046.91','352.297','2.46091','0','0','0.942641','0.333809','180','100','1'),
	('185549','530','1','-4186.47','3047.19','352.316','2.60054','0','0','0.96363','0.267239','180','100','1'),
	('185549','530','1','-3915.67','2983.4','396.957','-1.91986','0','0','-0.819151','0.573577','180','100','1'),
	('185549','530','1','-3883.21','3004.11','399.738','-1.64061','0','0','-0.731354','0.681998','180','100','1'),
	('185549','530','1','-3883.26','3001.55','399.431','-2.3911','0','0','-0.930417','0.366502','180','100','1'),
	('185549','530','1','-3884.29','3003.3','400.063','-1.88496','0','0','-0.809018','0.587783','180','100','1'),
	('185549','530','1','-3903.02','3095.85','383.783','-2.28638','0','0','-0.909961','0.414694','180','100','1'),
	('185549','530','1','-3898.45','3093.06','383.667','2.53073','0','0','0.953717','0.300705','180','100','1'),
	('185549','530','1','-3900.75','3100.75','383.795','-0.436333','0','0','-0.216439','0.976296','180','100','1'),
	('185549','530','1','-4107.81','3023.42','352.142','1.06465','0','0','0.507538','0.861629','180','100','1'),
	('185549','530','1','-4113.58','3022.4','352.157','-0.645772','0','0','-0.317305','0.948324','180','100','1'),
	('185549','530','1','-3893.09','3677.17','374.516','-1.23918','0','0','-0.580701','0.814117','180','100','1'),
	('185549','530','1','-3892.47','3674','374.478','-2.14675','0','0','-0.878816','0.477161','180','100','1'),
	('185549','530','1','-4198.53','3168.91','355.847','-0.383972','0','0','-0.190809','0.981627','180','100','1'),
	('185549','530','1','-4197.01','3170.04','356.117','-1.15192','0','0','-0.54464','0.83867','180','100','1'),
	('185549','530','1','-4196.54','3167.69','356.348','-0.541052','0','0','-0.267238','0.96363','180','100','1'),
	('185549','530','1','-4020.07','3077.84','374.391','1.53589','0','0','0.694658','0.71934','180','100','1'),
	('185549','530','1','-4019.32','3079.74','375.109','-1.25664','0','0','-0.587786','0.809016','180','100','1'),
	('185549','530','1','-3917.21','2981.62','396.483','0.733038','0','0','0.358368','0.93358','180','100','1'),
	('185549','530','1','-3918.45','2982.44','397.24','-1.72788','0','0','-0.760407','0.649446','180','100','1'),
	('185549','530','1','-3839.35','3344.85','337.834','2.75762','0','0','0.981627','0.190809','180','100','1'),
	('185549','530','1','-3835.3','3344.77','338.155','-0.767945','0','0','-0.374607','0.927184','180','100','1'),
	('185549','530','1','-3846.43','3430.29','363.729','0.488692','0','0','0.241922','0.970296','180','100','1'),
	('185549','530','1','-3864.13','3439.06','363.679','-0.05236','0','0','-0.026177','0.999657','180','100','1'),
	('185549','530','1','-3863.24','3440.42','363.655','0.349066','0','0','0.173648','0.984808','180','100','1'),
	('185549','530','1','-3846.35','3439.34','363.628','-0.122173','0','0','-0.0610485','0.998135','180','100','1'),
	('185549','530','1','-3847.32','3441.39','363.648','0.453786','0','0','0.224951','0.97437','180','100','1'),
	('185549','530','1','-3686.21','3301','320.513','0.837758','0','0','0.406737','0.913545','180','100','1'),
	('185549','530','1','-3687.77','3299.85','320.307','2.75762','0','0','0.981627','0.190809','180','100','1'),
	('185549','530','1','-3692.64','3302.07','320.396','-0.226893','0','0','-0.113203','0.993572','180','100','1'),
	('185549','530','1','-3661.91','3379.15','320.377','0.890118','0','0','0.430511','0.902585','180','100','1'),
	('185549','530','1','-3660.65','3381.9','320.182','1.18682','0','0','0.559191','0.829039','180','100','1'),
	('185549','530','1','-3665.48','3380.11','320.365','-0.471239','0','0','-0.233445','0.97237','180','100','1'),
	('185549','530','1','-3685.07','3305.97','320.198','-2.87979','0','0','-0.991445','0.130528','180','100','1'),
	('185549','530','1','-3688.3','3308.93','320.337','1.65806','0','0','0.737276','0.675591','180','100','1'),
	('185549','530','1','-3690.65','3306.77','320.43','-2.79253','0','0','-0.984808','0.173647','180','100','1'),
	('185549','530','1','-3879.37','3665.22','374.393','-2.30383','0','0','-0.913544','0.406739','180','100','1'),
	('185549','530','1','-3990.42','3139.13','372.878','-2.61799','0','0','-0.965925','0.258821','180','100','1'),
	('185549','530','1','-3991.59','3134.33','372.703','-0.017453','0','0','-0.00872639','0.999962','180','100','1'),
	('185549','530','1','-3884.89','3684.98','374.492','-2.53073','0','0','-0.953717','0.300705','180','100','1'),
	('185549','530','1','-3800.8','3789.62','314','6.0912','0','0','-0.0436197','0.999048','180','100','1'),
	('185549','530','1','-3799.02','3788.06','314.158','3.19395','0','0','0.993572','0.113203','180','100','1'),
	('185549','530','1','-3798.91','3790.61','313.852','3.63029','0','0','-0.0610485','0.998135','180','100','1'),
	('185549','530','1','-3641.79','3754.52','310.101','1.45284','0','0','-0.0663218','0.997798','180','100','1'),
	('185549','530','1','-3645.24','3757.79','310.388','0.207979','0','0','0.103802','0.994598','180','100','1'),
	('185549','530','1','-3644.38','3760.09','310.156','6.016','0','0','0.133196','-0.99109','180','100','1'),
	('185549','530','1','-3712.25','3792.24','310.142','2.55553','0','0','-0.0663218','0.997798','180','100','1'),
	('185549','530','1','-3712.3','3796.46','310.15','3.62367','0','0','0.97109','-0.238712','180','100','1'),
	('185549','530','1','-3715.01','3796.77','310.24','5.29264','0','0','0.475274','-0.879838','180','100','1'),
	('185549','530','1','-3871.6','3780.4','348.89','4.27005','0','0','-0.756802','-0.653644','180','100','1'),
	('185549','530','1','-3875.84','3780.98','348.881','3.86949','0','0','-0.0663218','0.997798','180','100','1'),
	('185549','530','1','-3875.44','3765.05','348.977','2.10235','0','0','-0.262375','0.964966','180','100','1');

	delete from `creature` where `id` = 22991;
	insert into `creature` (`id`, `map`, `spawnMask`, `modelid`, `equipment_id`, `position_x`, `position_y`, `position_z`, `orientation`, `spawntimesecs`, `spawndist`, `currentwaypoint`, `curhealth`, `curmana`, `DeathState`, `MovementType`) values
	('22991','530','1','0','0','-4110.19','3122.64','358.083','-0.034907','180','0','0','6900','0','0','0'),	
	('22991','530','1','0','0','-4109.06','3019.1','352.24','0.261799','180','0','0','6900','0','0','0'),
	('22991','530','1','0','0','-4107.93','3121.5','357.427','1.01229','180','0','0','6900','0','0','0'),
	('22991','530','1','0','0','-3996.89','3142.12','372.729','3.05433','180','0','0','6900','0','0','0'),
	('22991','530','1','0','0','-3955.86','3222.16','347.503','0.244346','180','0','0','6900','0','0','0'),
	('22991','530','1','0','0','-4049.31','3285.9','348.335','1.43117','180','0','0','6900','0','0','0'),
	('22991','530','1','0','0','-4076.79','3412.91','334.617','-1.0821','180','0','0','6900','0','0','0'),
	('22991','530','1','0','0','-4113.58','3022.4','352.157','-0.645772','180','0','0','6900','0','0','0'),
	('22991','530','1','0','0','-4077.92','3412.57','334.768','-0.733038','180','0','0','6900','0','0','0'),
	('22991','530','1','0','0','-4044.66','3287.29','348.362','0.349066','180','0','0','6900','0','0','0'),
	('22991','530','1','0','0','-3965.16','3232.7','347.552','-0.122173','180','0','0','6900','0','0','0'),
	('22991','530','1','0','0','-3953.3','3227.94','347.564','-0.244346','180','0','0','6900','0','0','0'),
	('22991','530','1','0','0','-4108.31','3123.66','357.633','-0.680679','180','0','0','6900','0','0','0'),
	('22991','530','1','0','0','-4076.99','3415.22','334.008','-2.33874','180','0','0','6900','0','0','0'),
	('22991','530','1','0','0','-4041.39','3271','346.642','-2.09439','180','0','0','6900','0','0','0'),
	('22991','530','1','0','0','-3835.3','3344.77','338.155','-0.767945','180','0','0','6900','0','0','0'),
	('22991','530','1','0','0','-3857.69','3426.25','363.733','-0.087267','180','0','0','6900','0','0','0'),
	('22991','530','1','0','0','-3845.16','3332.2','338.59','2.9147','180','0','0','6900','0','0','0'),
	('22991','530','1','0','0','-3875.44','3765.05','348.977','2.10235','180','0','0','6900','0','0','0'),
	('22991','530','1','0','0','-3875.84','3780.98','348.881','3.86949','180','0','0','6900','0','0','0'),
	('22991','530','1','0','0','-3871.6','3780.4','348.89','4.27005','180','0','0','6900','0','0','0'),
	('22991','530','1','0','0','-3715.01','3796.77','310.24','5.29264','180','0','0','6900','0','0','0'),
	('22991','530','1','0','0','-3712.3','3796.46','310.15','3.62367','180','0','0','6900','0','0','0'),
	('22991','530','1','0','0','-3712.25','3792.24','310.142','2.55553','180','0','0','6900','0','0','0'),
	('22991','530','1','0','0','-3644.38','3760.09','310.156','6.016','180','0','0','6900','0','0','0'),
	('22991','530','1','0','0','-3645.24','3757.79','310.388','0.207979','180','0','0','6900','0','0','0'),
	('22991','530','1','0','0','-4187.52','3040.39','352.071','-0.017453','180','0','0','6900','0','0','0'),
	('22991','530','1','0','0','-4184.98','3044.71','352.394','1.81514','180','0','0','6900','0','0','0'),
	('22991','530','1','0','0','-3884.29','3003.3','400.063','-1.88496','180','0','0','6900','0','0','0'),
	('22991','530','1','0','0','-3883.26','3001.55','399.431','-2.3911','180','0','0','6900','0','0','0'),
	('22991','530','1','0','0','-3883.21','3004.11','399.738','-1.64061','180','0','0','6900','0','0','0'),
	('22991','530','1','0','0','-4107.81','3023.42','352.142','1.06465','180','0','0','6900','0','0','0'),
	('22991','530','1','0','0','-3915.67','2983.4','396.957','-1.91986','180','0','0','6900','0','0','0'),
	('22991','530','1','0','0','-4186.47','3047.19','352.316','2.60054','180','0','0','6900','0','0','0'),
	('22991','530','1','0','0','-4192.02','3046.91','352.297','2.46091','180','0','0','6900','0','0','0'),
	('22991','530','1','0','0','-4192.61','3045.1','352.096','3.14159','180','0','0','6900','0','0','0'),
	('22991','530','1','0','0','-3903.02','3095.85','383.783','-2.28638','180','0','0','6900','0','0','0'),
	('22991','530','1','0','0','-3900.75','3100.75','383.795','-0.436333','180','0','0','6900','0','0','0'),
	('22991','530','1','0','0','-3898.45','3093.06','383.667','2.53073','180','0','0','6900','0','0','0'),
	('22991','530','1','0','0','-4189.67','3039.9','352.247','-0.785398','180','0','0','6900','0','0','0'),
	('22991','530','1','0','0','-4018.35','3076.7','375.29','-0.733038','180','0','0','6900','0','0','0'),
	('22991','530','1','0','0','-3846.43','3430.29','363.729','0.488692','180','0','0','6900','0','0','0'),
	('22991','530','1','0','0','-3892.47','3674','374.478','-2.14675','180','0','0','6900','0','0','0'),
	('22991','530','1','0','0','-3917.21','2981.62','396.483','0.733038','180','0','0','6900','0','0','0'),
	('22991','530','1','0','0','-4019.32','3079.74','375.109','-1.25664','180','0','0','6900','0','0','0'),
	('22991','530','1','0','0','-4020.07','3077.84','374.391','1.53589','180','0','0','6900','0','0','0'),
	('22991','530','1','0','0','-4196.54','3167.69','356.348','-0.541052','180','0','0','6900','0','0','0'),
	('22991','530','1','0','0','-4197.01','3170.04','356.117','-1.15192','180','0','0','6900','0','0','0'),
	('22991','530','1','0','0','-4198.53','3168.91','355.847','-0.383972','180','0','0','6900','0','0','0'),
	('22991','530','1','0','0','-3839.35','3344.85','337.834','2.75762','180','0','0','6900','0','0','0'),
	('22991','530','1','0','0','-3918.45','2982.44','397.24','-1.72788','180','0','0','6900','0','0','0'),
	('22991','530','1','0','0','-3893.09','3677.17','374.516','-1.23918','180','0','0','6900','0','0','0'),
	('22991','530','1','0','0','-3864.13','3439.06','363.679','-0.05236','180','0','0','6900','0','0','0'),
	('22991','530','1','0','0','-3863.24','3440.42','363.655','0.349066','180','0','0','6900','0','0','0'),
	('22991','530','1','0','0','-3846.35','3439.34','363.628','-0.122173','180','0','0','6900','0','0','0'),
	('22991','530','1','0','0','-3847.32','3441.39','363.648','0.453786','180','0','0','6900','0','0','0'),
	('22991','530','1','0','0','-3686.21','3301','320.513','0.837758','180','0','0','6900','0','0','0'),
	('22991','530','1','0','0','-3687.77','3299.85','320.307','2.75762','180','0','0','6900','0','0','0'),
	('22991','530','1','0','0','-3692.64','3302.07','320.396','-0.226893','180','0','0','6900','0','0','0'),
	('22991','530','1','0','0','-3661.91','3379.15','320.377','0.890118','180','0','0','6900','0','0','0'),
	('22991','530','1','0','0','-3660.65','3381.9','320.182','1.18682','180','0','0','6900','0','0','0'),
	('22991','530','1','0','0','-3665.48','3380.11','320.365','-0.471239','180','0','0','6900','0','0','0'),
	('22991','530','1','0','0','-3685.07','3305.97','320.198','-2.87979','180','0','0','6900','0','0','0'),
	('22991','530','1','0','0','-3688.3','3308.93','320.337','1.65806','180','0','0','6900','0','0','0'),
	('22991','530','1','0','0','-3690.65','3306.77','320.43','-2.79253','180','0','0','6900','0','0','0'),
	('22991','530','1','0','0','-3879.37','3665.22','374.393','-2.30383','180','0','0','6900','0','0','0'),
	('22991','530','1','0','0','-3990.42','3139.13','372.878','-2.61799','180','0','0','6900','0','0','0'),
	('22991','530','1','0','0','-3991.59','3134.33','372.703','-0.017453','180','0','0','6900','0','0','0'),
	('22991','530','1','0','0','-3884.89','3684.98','374.492','-2.53073','180','0','0','6900','0','0','0'),
	('22991','530','1','0','0','-3641.79','3754.52','310.101','1.45284','180','0','0','6900','0','0','0'),
	('22991','530','1','0','0','-3800.8','3789.62','314','6.0912','180','0','0','6900','0','0','0'),
	('22991','530','1','0','0','-3799.02','3788.06','314.158','3.19395','180','0','0','6900','0','0','0'),
	('22991','530','1','0','0','-3798.91','3790.61','313.852','3.63029','180','0','0','6900','0','0','0');
    
    

        -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -
        -- -- PLACE UPDATE SQL ABOVE -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
        -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -

        -- If we get here ok, commit the changes
        IF bRollback = TRUE THEN
            ROLLBACK;
            SHOW ERRORS;
            SELECT '* UPDATE FAILED *' AS `===== Status =====`,@cCurResult AS `===== DB is on Version: =====`;



        ELSE
            COMMIT;
            SELECT '* UPDATE COMPLETE *' AS `===== Status =====`,@cNewResult AS `===== DB is now on Version =====`;
        END IF;
    ELSE    -- Current version is not the expected version
        IF (@cCurResult = @cNewResult) THEN    -- Does the current version match the new version
            SELECT '* UPDATE SKIPPED *' AS `===== Status =====`,@cCurResult AS `===== DB is already on Version =====`;
        ELSE    -- Current version is not one related to this update
            IF(@cCurResult IS NULL) THEN    -- Something has gone wrong
                SELECT '* UPDATE FAILED *' AS `===== Status =====`,'Unable to locate DB Version Information' AS `============= Error Message =============`;
            ELSE
		IF(@cOldResult IS NULL) THEN    -- Something has gone wrong
		    SET @cCurVersion := (SELECT `version` FROM db_version ORDER BY `version` DESC, STRUCTURE DESC, CONTENT DESC LIMIT 0,1);
		    SET @cCurStructure := (SELECT `STRUCTURE` FROM db_version ORDER BY `version` DESC, STRUCTURE DESC, CONTENT DESC LIMIT 0,1);
		    SET @cCurContent := (SELECT `Content` FROM db_version ORDER BY `version` DESC, STRUCTURE DESC, CONTENT DESC LIMIT 0,1);
                    SET @cCurOutput = CONCAT(@cCurVersion, '_', @cCurStructure, '_', @cCurContent, ' - ',@cCurResult);
                    SET @cOldResult = CONCAT('Rel',@cOldVersion, '_', @cOldStructure, '_', @cOldContent, ' - ','IS NOT APPLIED');
                    SELECT '* UPDATE SKIPPED *' AS `===== Status =====`,@cOldResult AS `=== Expected ===`,@cCurOutput AS `===== Found Version =====`;
		ELSE
		    SET @cCurVersion := (SELECT `version` FROM db_version ORDER BY `version` DESC, STRUCTURE DESC, CONTENT DESC LIMIT 0,1);
		    SET @cCurStructure := (SELECT `STRUCTURE` FROM db_version ORDER BY `version` DESC, STRUCTURE DESC, CONTENT DESC LIMIT 0,1);
		    SET @cCurContent := (SELECT `Content` FROM db_version ORDER BY `version` DESC, STRUCTURE DESC, CONTENT DESC LIMIT 0,1);
                    SET @cCurOutput = CONCAT(@cCurVersion, '_', @cCurStructure, '_', @cCurContent, ' - ',@cCurResult);
                    SELECT '* UPDATE SKIPPED *' AS `===== Status =====`,@cOldResult AS `=== Expected ===`,@cCurOutput AS `===== Found Version =====`;
                END IF;
            END IF;
        END IF;
    END IF;
END $$

DELIMITER ;

-- Execute the procedure
CALL update_mangos();

-- Drop the procedure
DROP PROCEDURE IF EXISTS `update_mangos`;

